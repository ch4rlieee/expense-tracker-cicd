pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "expense-tracker"
        DOCKER_TAG = "${BUILD_NUMBER}"
        SELENIUM_IMAGE = "expense-tracker-selenium"
        CONTAINER_NAME = "expense-tracker-app"
        SELENIUM_CONTAINER = "selenium-tests"
    }
    
    stages {
        stage('Code Checkout') {
            steps {
                echo '========== Stage 1: Code Checkout =========='
                checkout scm
                echo 'Code checked out successfully from GitHub'
            }
        }
        
        stage('Code Linting') {
            steps {
                echo '========== Stage 2: Code Linting =========='
                script {
                    try {
                        // Install dependencies for linting
                        sh 'npm install'
                        
                        // Run ESLint
                        sh 'npm run lint'
                        echo '✓ Linting passed successfully'
                    } catch (Exception e) {
                        echo '⚠ Linting warnings found, but continuing...'
                        // Don't fail the build on linting warnings
                    }
                }
            }
        }
        
        stage('Code Build') {
            steps {
                echo '========== Stage 3: Code Build =========='
                script {
                    // Build Docker image for the application
                    sh """
                        docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                    """
                    echo "✓ Docker image built: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                }
            }
        }
        
        stage('Unit Testing') {
            steps {
                echo '========== Stage 4: Unit Testing =========='
                script {
                    // Run unit tests (placeholder as app has basic tests)
                    try {
                        sh 'npm test'
                        echo '✓ Unit tests passed'
                    } catch (Exception e) {
                        echo '⚠ No unit tests configured or test failed'
                    }
                }
            }
        }
        
        stage('Containerized Deployment') {
            steps {
                echo '========== Stage 5: Containerized Deployment =========='
                script {
                    // Stop and remove existing container if running (force remove)
                    sh """
                        docker rm -f ${CONTAINER_NAME} || true
                    """
                    
                    // Run the application container
                    sh """
                        docker run -d \
                            --name ${CONTAINER_NAME} \
                            --network bridge \
                            -p 8080:8083 \
                            -v expense-data:/data \
                            ${DOCKER_IMAGE}:${DOCKER_TAG}
                    """
                    
                    echo '✓ Application deployed in container'
                    
                    // Wait for application to start
                    sleep(time: 5, unit: 'SECONDS')
                    
                    // Health check
                    sh """
                        curl -f http://localhost:8080 || exit 1
                    """
                    echo '✓ Application health check passed'
                }
            }
        }
        
        stage('Selenium Testing') {
            steps {
                echo '========== Stage 6: Selenium Testing =========='
                script {
                    try {
                        // Build Selenium test image
                        sh """
                            docker build -f Dockerfile.selenium -t ${SELENIUM_IMAGE}:${DOCKER_TAG} .
                        """
                        echo '✓ Selenium test image built'
                        
                        // Create a custom network for tests
                        sh """
                            docker network create test-network || true
                        """
                        
                        // Connect app container to test network
                        sh """
                            docker network connect test-network ${CONTAINER_NAME} || true
                        """
                        
                        // Recreate app container with network alias
                        sh """
                            docker rm -f ${CONTAINER_NAME} || true
                            docker run -d \
                                --name ${CONTAINER_NAME} \
                                --network test-network \
                                --network-alias webapp \
                                -p 8080:8080 \
                                -v expense-data:/data \
                                ${DOCKER_IMAGE}:${DOCKER_TAG}
                        """
                        
                        sleep(time: 5, unit: 'SECONDS')
                        
                        // Run Selenium tests
                        sh """
                            docker run --rm \
                                --name ${SELENIUM_CONTAINER} \
                                --network test-network \
                                -v \$(pwd)/test-results:/test-results \
                                ${SELENIUM_IMAGE}:${DOCKER_TAG}
                        """
                        echo '✓ Selenium tests passed successfully'
                        
                    } catch (Exception e) {
                        echo "✗ Selenium tests failed: ${e.getMessage()}"
                        throw e
                    } finally {
                        // Cleanup test network
                        sh """
                            docker network disconnect test-network ${CONTAINER_NAME} || true
                            docker network rm test-network || true
                        """
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo '========================================='
            echo '✓✓✓ Pipeline executed successfully! ✓✓✓'
            echo '========================================='
            echo "Application is running at: http://localhost:8080"
            echo "Docker Image: ${DOCKER_IMAGE}:${DOCKER_TAG}"
        }
        
        failure {
            echo '========================================='
            echo '✗✗✗ Pipeline failed! ✗✗✗'
            echo '========================================='
            
            // Cleanup on failure
            script {
                sh """
                    docker rm -f ${CONTAINER_NAME} || true
                    docker network rm test-network || true
                """
            }
        }
        
        always {
            echo 'Cleaning up workspace...'
            // Archive test results if they exist
            archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
            
            // Clean up old images (keep last 5 builds)
            script {
                sh """
                    docker images ${DOCKER_IMAGE} --format '{{.Tag}}' | \
                    grep -E '^[0-9]+\$' | \
                    sort -rn | \
                    tail -n +6 | \
                    xargs -I {} docker rmi ${DOCKER_IMAGE}:{} || true
                """
            }
        }
    }
}
